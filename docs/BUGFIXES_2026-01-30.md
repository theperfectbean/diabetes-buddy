# Bug Fixes - January 30, 2026

## Issue: Setup Wizard Stuck with No Continue Button

### Problem
The setup wizard would get stuck at "Setting Up Knowledge Base" step with no way to progress. After setup completed with partial failures (e.g., ADA Standards failed), there was no Continue button to allow the user to proceed.

### Root Cause
In `web/static/app.js`, the `nextStep()` function had logic that prevented progression on step 3 regardless of setup completion status.

### Fix
Added a `setupComplete` flag to track when setup finishes (success or partial failure):

1. Added `this.setupComplete = false` in constructor (line 1327)
2. Modified `nextStep()` to allow progression when `setupComplete=true` (lines 1426-1435)
3. Modified `updateUI()` to enable Continue button when setup is complete (lines 1478-1494)
4. Modified `runSetup()` to set `this.setupComplete = true` after setup finishes (line 1570)

---

## Issue: ADA Standards Failing to Fetch

### Problem 1: asyncio.run() Error
Error: `asyncio.run() cannot be called from a running event loop`

**Root Cause**: FastAPI/uvicorn already runs an event loop. Calling `asyncio.run()` inside fails.

**Initial Fix Attempt**: Added `nest_asyncio` to allow nested event loops.

### Problem 2: uvloop Incompatibility
Error: `Can't patch loop of type <class 'uvloop.Loop'>`

**Root Cause**: `nest_asyncio` doesn't work with `uvloop`, which uvicorn uses by default.

### Final Fix
Changed `_fetch_from_pmc()` in `agents/knowledge_fetcher.py` to use a ThreadPoolExecutor:

```python
import concurrent.futures

def run_in_thread():
    """Run async code in a new thread with its own event loop."""
    new_loop = asyncio.new_event_loop()
    asyncio.set_event_loop(new_loop)
    try:
        return new_loop.run_until_complete(fetch_all())
    finally:
        new_loop.close()

with concurrent.futures.ThreadPoolExecutor(max_workers=1) as executor:
    future = executor.submit(run_in_thread)
    results = future.result(timeout=300)
```

This runs the async PMC fetching code in a separate thread with its own event loop, avoiding conflicts with uvicorn's uvloop.

---

## Issue: OpenAPS Documentation Git Error

### Problem
Error: `fatal: detected dubious ownership in repository at '/app/docs/knowledge-sources/guideline/openaps_docs/latest'`

### Root Cause
The git repository was cloned by a user on the host system, but the Docker container runs as root. Git's security check flags this ownership mismatch.

### Fix
Added `git config --global --add safe.directory` before git operations in `_fetch_from_git()`:

```python
subprocess.run(
    ["git", "config", "--global", "--add", "safe.directory", str(repo_dir)],
    check=False,
    capture_output=True
)
```

---

## Issue: Knowledge Status API 500 Error

### Problem
Error: `Error getting knowledge status: 'type'` with HTTP 500

### Root Cause
1. The `user_profile.json` contained a malformed entry `{"test": "entry"}` without `type` or `id` keys
2. Multiple duplicate entries from repeated setup attempts

### Fix
1. Added validation in `get_all_sources_status()` to skip malformed entries:
   ```python
   if 'type' not in source_info or 'id' not in source_info:
       continue
   ```

2. Added duplicate detection:
   ```python
   seen = set()
   # ...
   key = (source_type, source_id)
   if key in seen:
       continue
   seen.add(key)
   ```

3. Cleaned up `user_profile.json` to remove malformed/duplicate entries

---

## Issue: ADA Standards Showing as "Outdated"

### Problem
ADA Standards showed as "outdated" immediately after being fetched.

### Root Cause
`_get_latest_metadata()` only looked for metadata in a `/latest` subdirectory, but PMC sources save metadata directly in the source folder (no `/latest` subdirectory).

### Fix
Updated `_get_latest_metadata()` to check both paths:

```python
def _get_latest_metadata(self, source_type: str, source_id: str) -> Dict:
    # Try "latest" subdirectory first (git sources, direct downloads)
    source_dir = self.docs_dir / source_type / source_id / "latest"
    metadata_path = source_dir / "metadata.json"

    if metadata_path.exists():
        with open(metadata_path, 'r') as f:
            return json.load(f)

    # Also check direct path (PMC sources don't use "latest" subdirectory)
    direct_metadata_path = self.docs_dir / source_type / source_id / "metadata.json"
    if direct_metadata_path.exists():
        with open(direct_metadata_path, 'r') as f:
            return json.load(f)

    return {}
```

---

## Issue: Docker Build Context Too Large (2.1GB)

### Problem
Docker build was sending 2.1GB to the daemon, making builds very slow.

### Root Cause
The `docs/` folder contained 5.6GB of git repositories (community knowledge sources) that were being included in the build context.

### Fix
1. Updated `.dockerignore` to exclude volume-mounted directories:
   ```
   docs/
   data/
   logs/
   config/
   scripts/
   ```

2. Updated `Dockerfile` to create empty directories for volume mounts instead of copying:
   ```dockerfile
   RUN mkdir -p /app/docs /app/data /app/logs /app/config /app/scripts
   ```

---

## Issue: Inconsistent Sources Section Format

### Problem
Response sources sections were inconsistently formatted - sometimes "**Sources", sometimes "### Sources", sometimes missing entirely.

### Root Cause
The LLM prompt template in `agents/unified_agent.py` didn't enforce consistent formatting requirements for the sources section.

### Fix
Updated `_build_prompt()` to include mandatory sources section formatting:

```python
## General Guidelines
- Be conversational and helpful
- For medical decisions, remind them to consult your healthcare team
- Be concise but thorough
- NEVER invent or hallucinate references to books, papers, or external sources
- You MUST end every response with:

### Sources
- [source name]: [confidence if <0.8]
```

---

## Issue: Safety Auditor Not Catching Dosing Questions

### Problem
Queries asking for specific insulin dosing advice (e.g., "How much insulin for 50g carbs?") were not being caught by the safety system and returned "No information found" instead of a safety disclaimer.

### Root Cause
The safety auditor only checked responses for specific dose amounts, but didn't detect queries asking for dosing calculations or advice.

### Fix
Added query-level detection for dosing questions in both `SafetyAuditor` and `UnifiedAgent`:

1. Added `DOSING_QUERY_PATTERNS` with regex patterns:
   ```python
   DOSING_QUERY_PATTERNS = [
       r'\bhow much insulin\b',
       r'\binsulin dose\b',
       r'\bbolus calculation\b',
       r'\bcalculate.*bolus\b',
       r'\bcarb ratio\b',
       r'\binsulin.*carb.*ratio\b',
       r'\bcalculate.*insulin\b',
       r'\bdose.*carbs?\b',
       r'\binsulin.*for.*carbs?\b',
   ]
   ```

2. Added `_detect_dosing_query()` method to check queries before processing

3. Return safety response: "I cannot provide specific insulin dosing advice. Individual insulin-to-carbohydrate ratios vary. Please consult your diabetes care team.\n\n### Sources\n- Safety guidelines"

---

## Issue: Product-Specific Config Questions

### Problem
Queries asking for product-specific configuration (e.g., "How do I configure autosens?") returned "No information found" instead of appropriate educational guidance.

### Root Cause
No detection for product-specific configuration questions that should be handled with general education rather than specific instructions.

### Fix
Added query-level detection for product configuration questions:

1. Added `PRODUCT_CONFIG_PATTERNS` with regex patterns:
   ```python
   PRODUCT_CONFIG_PATTERNS = [
       r'\b(configure|setup|install|set up)\s+(autosens|autotune|extended bolus|temp basal|basal rate|carb ratio|correction factor|sensitivity factor)\b',
       r'\bhow.*(configure|setup|install|set up).*(pump|cgm|sensor|loop|openaps|androidaps|camaps|control.?iq|omnipod|tandem|medtronic)\b',
       r'\b(configure|setup|install|set up).*(pump|cgm|sensor|loop|openaps|androidaps|camaps|control.?iq|omnipod|tandem|medtronic)\b',
   ]
   ```

2. Added `_detect_product_config_query()` method

3. Return educational response: "I can provide general diabetes management principles, but cannot give device-specific configuration instructions. Please refer to your device's user manual or contact your healthcare provider.\n\n### Sources\n- Educational resources"

---

## Files Modified

| File | Changes |
|------|---------|
| `web/static/app.js` | Added `setupComplete` flag and button logic for partial failures |
| `agents/knowledge_fetcher.py` | Thread pool for PMC fetch, git safe.directory, metadata path lookup, duplicate handling |
| `agents/unified_agent.py` | Added sources section requirement, dosing/config query detection |
| `agents/safety.py` | Added dosing and config query patterns and detection |
| `config/device_registry.json` | Changed ADA Standards from `manual` to `pmc` fetch method with PMC IDs |
| `config/user_profile.json` | Cleaned up malformed/duplicate entries |
| `.dockerignore` | Excluded volume-mounted directories |
| `Dockerfile` | Removed COPY for volume-mounted dirs, added mkdir |
| `requirements.txt` | Added `nest-asyncio>=1.6.0` (not used after uvloop fix, but kept for potential future use) |

---

## Dependencies Added

- `nest-asyncio>=1.6.0` - Added to requirements.txt (not actively used after switching to thread pool approach, but kept for compatibility)

---

## Testing Notes

To test the setup wizard:
1. Clear `knowledge_sources` array in `config/user_profile.json`
2. Remove `setup_completed_at` field
3. Restart container: `docker-compose restart`
4. Hard refresh browser (Ctrl+Shift+R)
5. Setup wizard should appear and all sources should fetch successfully

To test safety fixes:
1. Test dosing queries: "How much insulin for 50g carbs?", "What's my carb ratio?"
2. Test config queries: "How do I configure autosens?", "How to setup my pump?"
3. Verify responses include appropriate safety disclaimers and "### Sources" sections
